# External node

This following steps should make it clear, how an external node, running
outside of Hetzner cloud, can be added to the cluster as an additional worker

## Prerequisites

* Configure a network overlay which supports secure tunneling over public
  networks.
* Configure cluster without private network between the nodes.
* External node needs to be [setup with kubeadm][kubeadm]
* External node needs a public IPv4 address

[kubeadm]:https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/

## Steps

1. Create a manual node object in the API server. It is important to set the
providerID to something unique per node and it should not start with `hcloud://`

    ```sh
    kubectl apply -f - <<EOF
    apiVersion: v1
    kind: Node
    metadata:
      name: test
      labels:
        beta.kubernetes.io/arch: amd64
        beta.kubernetes.io/os: linux
        failure-domain.beta.kubernetes.io/region: nbg1
        failure-domain.beta.kubernetes.io/zone: nbg1-dc1
        kubernetes.io/arch: amd64
        kubernetes.io/hostname: test
        kubernetes.io/os: linux
    spec:
      providerID: hetzner://unique-id
    EOF
    ```

1. Generate the token to join the node to the cluster

    ```sh
    # Get control plane IP from API
    CONTROL_PLANE_IP=$(kubectl get nodes -l node-role.kubernetes.io/master -o json  | jq -r '.items[].status.addresses[] | select(.type == "ExternalIP") | .address' | head -n1)

    # Generate new bootstrap token to join the node
    ssh root@${CONTROL_PLANE_IP} kubeadm token create --ttl 1h --print-join-command
    # The output of that command is used in the next step
    # kubeadm join 1.1.1.1:6443 --token xxxxxx.yyyyyyyyyyyyyyyy --discovery-token-ca-cert-hash sha256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    ```

1. Join the node

    * SSH into the external node
    * As root user run the command generated by the previous step

1. Approve certificates

    ```sh
    # Find the name of the csr from node test
    kubectl get csr
    NAME        AGE   SIGNERNAME                      REQUESTOR          CONDITION
    csr-7t26r   21m   kubernetes.io/kubelet-serving   system:node:test   Pending

    # Introspect the request CSR, to validate requested IPs and hostnames
    kubectl describe csr csr-7t26r

    # And finally approve the request
    kubectl certificates approve csr-7t26r
    ```




